<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="&quot;An ML model to estimate FHG coefficients and reproduce channel shape using Ding../man's r coefficient&quot;
">
<title>Channel FHG - Machine Learning Model • hydrofabric</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Channel FHG - Machine Learning Model">
<meta property="og:description" content="&quot;An ML model to estimate FHG coefficients and reproduce channel shape using Ding../man's r coefficient&quot;
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydrofabric</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/NOAA-OWP/hydrofabric/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Channel FHG - Machine Learning Model</h1>
                        <h4 data-toc-skip class="author">Arash Modaresi
Rad</h4>
            <address class="author_afil">
      Lynker,
NOAA-Affiliate<br><h4 data-toc-skip class="author">Mike
Johnson</h4>
            <address class="author_afil">
      Lynker, NOAA-Affiliate<br><small class="dont-index">Source: <a href="https://github.com/NOAA-OWP/hydrofabric/blob/HEAD/vignettes/07-channel-geometry.Rmd" class="external-link"><code>vignettes/07-channel-geometry.Rmd</code></a></small>
      <div class="d-none name"><code>07-channel-geometry.Rmd</code></div>
    </address>
</address>
</div>

    
    
<div class="section level2">
<h2 id="a-ml-approach-to-estimate-channel-geometry">A ML approach to estimate channel geometry<a class="anchor" aria-label="anchor" href="#a-ml-approach-to-estimate-channel-geometry"></a>
</h2>
<p><strong>Check out our <a href="https://sites.google.com/u.boisestate.edu/conus-fhg/home" class="external-link">website</a>
that provides details of our approach.</strong></p>
<div class="section level3">
<h3 id="what-is-fhg">What is FHG?<a class="anchor" aria-label="anchor" href="#what-is-fhg"></a>
</h3>
<p>The feature hydraulic geometry (FHG) is an extension of the work by
<a href="https://books.google.com/books?hl=en&amp;lr=&amp;id=K496gE_YsJoC&amp;oi=fnd&amp;pg=PA1&amp;dq=Leopold,+L.B.,+Maddock,+Jr.,+T.,+1953.+The+hydraulic+geometry+of+stream+channels+and+some+physiographic+implications.+US+Geological+Survey+Professional+Paper+252.&amp;ots=FjrJEtp6Cj&amp;sig=82Sl3dnacB4uUM4DY59nObbi6mQ" class="external-link">Leopold
and Maddock, 1953</a> to apply the learned hydraulic geometry relations
to other locations with the same holistic hydrologic feature.</p>
<p>The hydraulic geometry relations suggest that measured hydraulic
characteristics at a channel cross-section including width, depth, and
velocity vary with discharge as a simple power-law function. These
relations present an opportunity to develop a time-varying
representation of channel depth and width and in turn, can determine the
shape of the channel.</p>
</div>
<div class="section level3">
<h3 id="why-build-a-machine-learning-model">Why build a machine learning model?<a class="anchor" aria-label="anchor" href="#why-build-a-machine-learning-model"></a>
</h3>
<p>Currently, Digital Elevation Model’s (DEM) can be used to extract
floodplain topology but DEMs cannot penetrate deep into the water and
thus we have a missing bathymetry at bankfull and below bankfull
conditions. This missing bathymetry can through off modeling efforts by
not accounting for the missing volume. The hydraulic geometry method
offers a solution to capture the missing bathymetry and resolve this
issue.</p>
<p>Deriving hydraulic geometry relations is only possible where there
are measurements of width, depth, and velocity at different discharge
values such as few selected USGS sites or locations where there are
frequent measurements of Acoustic Doppler Current Profiler (ADCP). A
great source of such a dataset is the USGS HYDRoacoustic dataset in
support of the Surface Water Oceanographic Topography satellite mission
<a href="https://data.usgs.gov/datacatalog/data/USGS:57435ae5e4b07e28b660af55" class="external-link">HYDRoSWOT</a>.
This limits the applicability of this approach only to sites where such
measurements have taken place.</p>
<p>The Office of Water Prediction (OWP), on the other hand, has a
mission to provide a 3D channel geometry dataset in support of <a href="https://www.weather.gov/media/owp/oh/docs/2021-OWP-NWM-NextGen-Framework.pdf" class="external-link">Next
Gen Water Modeling Framework</a> and Flood Inundation Mapping (FIM).
This requires a 3D representation of channel shape both where there are
field measurements (i.e., Lidar, HEC-RAS models, etc.) and where there
is no measurement for all Reaches across CONUS. Therefore, here we learn
hydraulic geometry from sites where data is available (HYDRoSWOT) using
machine learning and apply it to other locations with no data.</p>
<p>The ML model will be able to predict width, depth, and velocity as
well as a simplified representation of channel shape that help reproduce
the missing bathymetry data where data is not available.</p>
</div>
<div class="section level3">
<h3 id="repository">Repository<a class="anchor" aria-label="anchor" href="#repository"></a>
</h3>
<div class="section level4">
<h4 id="cloning">Cloning<a class="anchor" aria-label="anchor" href="#cloning"></a>
</h4>
<pre class="shell"><code>git clone https://github.com/LynkerIntel/conus-fhg.git</code></pre>
</div>
<div class="section level4">
<h4 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<blockquote>
<p>you can run the model using the following com../mand:</p>
</blockquote>
<pre class="shell"><code>./run_ml.bash -c mymodel -n -1 -x False -y False -r 0.8</code></pre>
<p>Where:</p>
<p><strong>-c</strong> is the name of the running script and generated
folder with outputs. Any name.</p>
<p><strong>-n</strong> is the number of cores to be used in parallel. An
integer depends on the number of cores. Use -1 for utilizing all</p>
<p><strong>-x</strong> is the to apply a transformation to predictor
variables. Options are True and False</p>
<p><strong>-y</strong> is the to apply a transformation to predicted
variables. Options are True and False</p>
<p><strong>-r</strong> is the coefficient of determination used to
filter bad measurements in ADCP data. Ranges from 0.0-1.0</p>
</div>
</div>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>Here we use the USGS “HYDRoacoustic dataset in support of the Surface
Water Oceanographic Topography satellite” mission (HYDRoSWOT) to:</p>
<ol style="list-style-type: decimal">
<li>Build a time-varying model of in-channel geometry that represents
the width, and depth of a channel given a discharge value. This can be
achieved by modeling the fitted at a feature hydraulic geometry (FHG)
using climate, catchment, surface, and subsurface characteristics. These
relations can be described as:</li>
</ol>
<ul>
<li><p>TW = <span class="math inline">\(a . Q ^{b}\)</span></p></li>
<li><p>Y = <span class="math inline">\(c . Q ^{f}\)</span></p></li>
<li><p>V = <span class="math inline">\(k . Q ^{m}\)</span></p></li>
</ul>
<p><a href="https://www.preprints.org/../manuscript/202212.0390/v1" class="external-link">Johnson et
al, 2023</a> provided a robust framework to get the best fits for the
above equations while maintaining the continuity relation. Here we use
the fitted parameters for the study to build an ML model.</p>
<ol start="2" style="list-style-type: decimal">
<li>Have a representation of curvature of in-channel shape where DEM
cannot penetrate to see the channel bathymetry. This can be done using
FHG coefficients namely f and b related to channel depth and width in
relation to discharge.</li>
</ol>
<p>According to Ding../man <a href="https://www.sciencedirect.com/science/article/pii/S0022169406005063?casa_token=gKpjjfHrupEAAAAA:Cp1tVhLnwlfddS38gpcKiyOm_xR09JeTgEtYZbCP-c8SUSth6Fx6gBPOWeyxZldCClEL20EJ2JI" class="external-link">(2007)</a>,
given that bankfull maximum depth Ym and bankfull width W∗ are known,
channel cross-sections are symmetrical, and that their form can be
approximated by</p>
<ul>
<li>Z = <span class="math inline">\(Y_{m} ^{*} . \big( \frac{2}{W*}
\big) ^{r} . x^{r}, \;\;\; 0 \leq x \leq \frac{W*}{2}\)</span>
</li>
</ul>
<p>where z is the height of the bed above the lowest channel elevation
(assumed to occur at the channel center), and x is the horizontal
distance from the center. A triangle is represented by r = 1, the “Lane
Type B stable channel” by r ≈ 1.75, a parabola by r = 2, and forms with
increasingly flatter bottoms and steeper banks by increasing values of
r; in the limit as r → ∞, the channel is rectangular. Values of r &lt; 1
characterize “convex” cross-sections.</p>
<div class="float">
<img src="../reference/figures/cshape2.jpg" alt="Example1"><div class="figcaption">Example1</div>
</div>
</div>
<div class="section level3">
<h3 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h3>
<p>The ML model establishes a relation between different attributes that
are aggregated at the catchment and local area and the FHG confidences
namely a, b, c, f, k, and m. These include</p>
<p>1- The reference fabric data - streamorde –&gt; Modified Strahler
stream order - arbolatesu –&gt; Arbolate sum, the sum of the lengths of
all digitized flowlines upstream from the downstream end of the
immediate flowline, in kilometers - roughness –&gt; ../manning’s
roughness - etc.</p>
<p>2- Soil data - clay_mean_0_5 –&gt; % clay - ksat_mean_0_5 –&gt; the
effective saturated hydraulic conductivity, (cm hr-1) - theta_s_mean_0_5
–&gt; the saturated soil water content, (cm3 cm-3) - etc.</p>
<p>3- From DEM - elevation –&gt; elevation (m) - slope –&gt; slope - US
NED Physiographic Diversity - etc.</p>
<p>4- The StreamCat dataset - Base flow index - NLCD - Road density -
etc.</p>
<p>5- Land surface features - Leaf area index - Soil moisture - NDVI -
etc.</p>
<p>6- Climate data - Precipitation - Evaporation - Temperature -
etc.</p>
<p>7- NWM simulations - NWM 2.1 quartiles - NWM 2.1 flood
frequencies</p>
<p>The codes for data preprocessing and cleaning reside in <a href="data_processing/">data_processing floder</a>. Codes for extracting
the data reside in <a href="data_retrieval/">data_retrieval floder</a>
and <a href="R/">R folder</a>. The original and the cleaned data for the
ML modeling are in <a href="data/">data folder</a> where training data
for the ML model is the <a href="data/Processed_merged_fhg.parquet">Processed_merged_fhg.parquet</a>
and data for validation and testing is <a href="data/Processed_adcp.parquet">Processed_adcp.parquet</a>.</p>
</div>
<div class="section level3">
<h3 id="ml-model">ML model<a class="anchor" aria-label="anchor" href="#ml-model"></a>
</h3>
<div class="section level4">
<h4 id="reducing-feature-space">Reducing feature space<a class="anchor" aria-label="anchor" href="#reducing-feature-space"></a>
</h4>
<p>This step consists of reducing a large feature space of more than
~400 variables to 60 features. This is done in multiple ways: 1- The
model is trained using all features and dropping the sigle least
important feature over a loop and retraining the model until we reach
peak model accuracy during training.</p>
<p>2- The remaining are grouped into meaningful clusters and are fed to
an AutoEncoder model to lower the dimention of data <img src="../reference/figures/keras_denoising_autoencoder_header.png" alt="Example2"></p>
<p>To lunch the autoencoder model navigate to <a href="auto_encoder/">this directory</a></p>
<pre class="shell"><code>cd auto_encoder</code></pre>
<p>and use this com../mand to begin autoencoding and generating new
features</p>
<pre class="shell"><code><span><span class="va">.</span><span class="op">/</span><span class="va">run_ae.bash</span> </span></code></pre>
</div>
<div class="section level4">
<h4 id="preventing-overfit">Preventing overfit<a class="anchor" aria-label="anchor" href="#preventing-overfit"></a>
</h4>
<p>This is done through multiple steps: 1- Splitting training to train
and validation and early stopping model when there are no improvements
to validation accuracy.</p>
<p>2- Performing A k-fold cross validation <img src="../reference/figures/grid_search_cross_validation.png" alt="Example3"></p>
<p>3- Initial out of bag model evaluation form list of 50 different ML
models and selecting the top 10 models for hyperparameter tunning</p>
<p>4- Ensamble learning including meta and voting models</p>
<p>5- The deep learning models also include dropout rates that prevent
overfitting</p>
</div>
<div class="section level4">
<h4 id="ensemble-learning">Ensemble learning<a class="anchor" aria-label="anchor" href="#ensemble-learning"></a>
</h4>
<p>At first stage we do an out of the box evaluation of different
models. These models have all their hyper parameters set to default and
are not tuned during the evaluation as a means of finding robust
algorithms for this problem.</p>
<p>Here we output 3 different models namely,</p>
<p>1- The best model that is the top model among the hyperparameter
tuned chosen 8 ML models coming from out of bag model evaluation</p>
<p>2- The voting ensemble model that is build on top of the chosen 8 ML
models</p>
<p>3- The meta learner model that is build on top of the chosen 8 ML
models</p>
<div class="float">
<img src="../reference/figures/comp.png" alt="Ens"><div class="figcaption">Ens</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h3>
<p>We then compare model results with ADCP measurements using multiple
goodness-of-fit criteria.</p>
<div class="section level4">
<h4 id="feature-importance">Feature importance<a class="anchor" aria-label="anchor" href="#feature-importance"></a>
</h4>
<p>We use a tree algorithm that is based on game theory and determine
XGBoost feature importance’s. This also allows us to look at inner
interactions between variables.</p>
<div class="float">
<img src="../reference/figures/fimp_order.png" alt="Ens"><div class="figcaption">Ens</div>
</div>
<p>For example low values of long term averaged soil moister are
associate with arid and semi-arid regions where we see a lot of
variability in stream flow and therefore high rate of change in river
width.</p>
<div class="float">
<img src="../reference/figures/fimp_scater.png" alt="Ens"><div class="figcaption">Ens</div>
</div>
</div>
<div class="section level4">
<h4 id="evaluation">Evaluation<a class="anchor" aria-label="anchor" href="#evaluation"></a>
</h4>
<p>Here we can look at different metrics including Normalized
Nash-Sutcliffe efficiency (NNSE) to check how the model performs in
terms of predicting river velocity, depth, and width for different
discharge measurements.</p>
<p>The image below shows NNSE values for each station that has more than
50 measurements of discharge-depth estimating depth(ft) using parameter
f form FHG relations. <img src="../reference/figures/Best_Model_Sub_f_cMAP_f_Y_Testing_NNSE.png" alt="Example4"><img src="../reference/figures/Best_Model_norm_f_CDF_f_Y_Testing_NNSE.png" alt="Example4_1"></p>
<p>We can also look at how the model for parameter f perfor../mance is
when predicting max flow: <img src="../reference/figures/Best_Model_Sub_f_scatter_type1_Y_act_max_f_Y_Testing.png" alt="Example5"></p>
<p>We see most of the error is associated with larger rivers that model
was not seen enough of during training due to limited availbility in
HYDRoSWOT.</p>
<div class="float">
<img src="../reference/figures/uncertain.png" alt="Uncertain"><div class="figcaption">Uncertain</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="channel-shape">Channel Shape<a class="anchor" aria-label="anchor" href="#channel-shape"></a>
</h3>
<p>Using parameters b and f we can derive r coefficient that describes
the curvature of the channel which looks like the figure below for the
CONUS. <img src="../reference/figures/R_pred.png" alt="Example6"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mike Johnson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
