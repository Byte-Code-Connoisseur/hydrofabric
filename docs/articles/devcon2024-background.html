<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content='"DevCon 2024 Hydrofabric Workshop"
'>
<title>Background • hydrofabric</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Background">
<meta property="og:description" content='"DevCon 2024 Hydrofabric Workshop"
'>
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydrofabric</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/NOAA-OWP/hydrofabric/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Background</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NOAA-OWP/hydrofabric/blob/HEAD/vignettes/devcon2024-background.Rmd" class="external-link"><code>vignettes/devcon2024-background.Rmd</code></a></small>
      <div class="d-none name"><code>devcon2024-background.Rmd</code></div>
    </div>

    
    
<p>The hydrofabric team is focused on delivering a consistent,
interoperable, flexible, cloud native solution for <a href="https://noaa-owp.github.io/hydrofabric/articles/01-intro-deep-dive.html" class="external-link">hydrofabric
data</a> to those interested in hydrologic modeling and geospatial
analysis. We aim to provide <em>open data to improve open science</em>
and it doing so strive to make <em>real data <a href="https://www.go-fair.org/fair-principles/" class="external-link">FAIR</a> data</em>.</p>
<p>In the contexts of DevCon, the hydrofabric provides the foundational
features, topology and attributes needed for cartography, web mapping,
geospatial analysis, machine learning, model evaluation, data
assimilation, and NextGen (and AWI data stream, NGIAB, etc)
applications. Outside of DevCon, it provides the needed infrastructure
to support other mutli-scale modeling needs (e.g. NHM, US Water Census,
Water Balance), vulnerability assessments, and more!</p>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Last year, we shared the concept of a <a href="https://noaa-owp.github.io/hydrofabric/articles/01-intro-deep-dive.html" class="external-link">hydrofabric</a>
and the current of NextGen data structures. A hydrofabric describes the
landscape and flow network discretizations, the essential connectivity
of network features, and the key reporting locations known as nexus
points. Combined these feature serve as both geospatail and
computational elements that allow the NextGen modeling infrastructure to
syncronious different models, formulations, and domains into a cohert
simulation and set of outputs.</p>
<div class="section level3">
<h3 id="key-highlights">Key Highlights<a class="anchor" aria-label="anchor" href="#key-highlights"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong>Design Philosophy</strong>: We adopt the OGC <a href="https://docs.opengeospatial.org/is/14-111r6/14-111r6.html" class="external-link">HY
Feature conceptual model</a> with custom modifications for NextGen
applications that define an explicit <a href="https://noaa-owp.github.io/hydrofabric/articles/hf_dm.html" class="external-link">data
model</a>. This fundamental data model and evolving mode of delevery
tailored for modeling and web infrastructure applications, emphasizing
efficiency and accuracy through use of modern geospatial and data
science formats. This included seven spatial and two a-spatial layers,
and future plans for an additional layer for water bodies and cross
sections. The NOAA enterprise hydrofabric is made up of 5 modular
components, all of which will be touched on today. These include those
seen below:</li>
</ol>
<div class="figure" style="text-align: center">
<img src="../reference/figures/roadmap2.png" alt="Enterprise Hydrofabric System" width="711"><p class="caption">
Enterprise Hydrofabric System
</p>
</div>
<ol start="2" style="list-style-type: decimal">
<li><p><strong>NHGF</strong>: A core, federally consistent data product
grounded in a common topology, reference fabric, and set of community
POIs. Collectively, these define a shared NOAA/USGS National Hydrologic
Geospatial Fabric (NHGF).</p></li>
<li><p><strong>Network Manipulation</strong>: In-depth exploration of
two <a href="https://noaa-owp.github.io/hydrofabric/articles/03-processing-deep-dive.html" class="external-link">network
manipulation</a> processes, refactoring and aggregating, that are
crucial for optimizing data usage.</p></li>
<li><p><strong>Egress Free Community Hydrofabric</strong> Data: Through
Lynker-Spatial we provide efficient, free access to hydrofabric and
hydrofabric-adjacent data. Over the last year, this system has had
~78,500 requests over 2,306 unique IPs with a month over month trend
nearing exponential.</p></li>
<li><p><strong>Data Subsetting</strong>: We demonstrated methods to <a href="https://noaa-owp.github.io/hydrofabric/articles/05-subsetting.html" class="external-link">extract
data subsets</a> for multi-scale modeling tasks using R and a <a href="https://github.com/lynker-spatial/hfsubsetCLI" class="external-link">Go-based CLI</a>.
Since then, the R version and underlying data stores have been
overhauled, the CLI implementation has transitioned to a (beta) <a href="https://www.lynker-spatial.com/hydrofabric/hfsubset/__docs__/" class="external-link">REST
API</a>, and a Python implementation is forthcoming.</p></li>
<li><p><strong>Enriching a hydrofabric</strong>: While the core
hydrofabric respect the above data model we demontrated hoe it could be
enhance through te addtioon of catchment attributes (both precomputed
and custom), flowpath attributes, and forcing weights. Since then,
through a partnership with ESIP we extended the climateR catalog to host
access endpoints to over 100,000 unique data resources, developed a e
machine learning models for estimating river bathymety and roughness,
tools to extract high resolution bathymetry informed ross sections, and
applid these across CONUS - all of which are provided in the egress free
cloud resources!</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="software">Software<a class="anchor" aria-label="anchor" href="#software"></a>
</h3>
<p>While the primary output of this system is a constantly evolving
FAIR, cloud native, data products complete with services, these are all
predicated on a suite of research (<code>hydrofab</code>) to publication
ready (<code>nhdplusTools</code>, <code>climateR</code>) software. This
suite of software is bundled together in
<code>NOAA-OWP/hydrofabric</code> provides a collection of R packages
designed for hydroscience data development and access. These packages
share an underlying design philosophy, grammar, and data structures,
making them easier to apply together. The packages cover a wide range of
data manipulation tasks, from importing and cleaning data, to building
custom hydrofabrics, to accessing and summarizing data from 100,000’s of
data resources. Assuming you are already <a href="https://noaa-owp.github.io/hydrofabric/articles/devcon2024-setup.html" class="external-link">up
and running with R, RStudio, and hydrofabric</a>, you can attach the
library to a working session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/NOAA-OWP/hydrofabric" class="external-link">hydrofabric</a></span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://github.com/NOAA-OWP/hydrofabric" class="external-link">library(hydrofabric)</a></code> will load the core packages
(alphabetical):</p>
<ul>
<li>
<a href="https://github.com/mikejohnson51/climateR" class="external-link">climateR</a> for
accessing federated data stores for parameter and attributes
estimation</li>
<li>
<a href="https://github.com/lynker-spatial/" class="external-link">hfsubsetR</a> for
cloud-based hydrofabric subsetting</li>
<li>
<a href="https://github.com/mikejohnson51/hydrofab" class="external-link">hydrofab</a> a
tool set for “fabricating” multiscale hydrofabrics</li>
<li>
<a href="https://github.com/mikejohnson51/ngen.hydrofab" class="external-link">ngen.hydrofab</a>
NextGen extensions for hydrofab</li>
<li>
<a href="https://github.com/doi-usgs/nhdplusTools/" class="external-link">nhdplusTools</a>
for network manipulation</li>
<li>
<a href="https://github.com/mikejohnson51/zonal" class="external-link">zonal</a> for
catchment parameter estimation</li>
</ul>
<p>Additionally it will load key geospatial data science libraries:</p>
<ul>
<li>
<code>dplyr</code> (data.frames)</li>
<li>
<code>sf</code> (vector)</li>
<li>
<code>terra</code> (raster)</li>
</ul>
<div class="section level4">
<h4 id="benefits-of-using-hydrofabric">Benefits of Using <code>hydrofabric</code><a class="anchor" aria-label="anchor" href="#benefits-of-using-hydrofabric"></a>
</h4>
<ul>
<li>
<strong>Consistency</strong>: Packages are designed to work
seamlessly together - with the Lynker-Spatial data stores - making
workflows more efficient.</li>
<li>
<strong>Readability</strong>: Syntax is designed to be
human-readable and expressive, which helps in writing clean and
understandable code.</li>
<li>
<strong>Efficiency</strong>: Functions are optimized for
performance, making data manipulation tasks faster.</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="lynker-spatial-data">Lynker-Spatial Data<a class="anchor" aria-label="anchor" href="#lynker-spatial-data"></a>
</h3>
<p>Hydrofabric artifacts are generated from a set of <a href="https://noaa-owp.github.io/hydrofabric/articles/01-intro-deep-dive.html" class="external-link">federally
consistent reference datasets</a> built in collaboration between NOAA,
the USGS, and Lynker for federal water modeling efforts. These artifacts
are designed to be easily updated, manipulated, and quality controlled
to meet the needs of a wide range of modeling tasks while leveraging the
best possible input data.</p>
<p>Cloud-native (modified both in structure and format) artifacts of the
<a href="https://noaa-owp.github.io/hydrofabric/articles/03-processing-deep-dive.html" class="external-link">refactored
and aggregated</a>, <a href="https://noaa-owp.github.io/hydrofabric/articles/04-applying-nextgen-model.html" class="external-link">NextGen
ready</a> resources are publicly available through <a href="https://www.lynker-spatial.com/" class="external-link">lynker-spatial</a> under an <a href="https://opendatacommons.org/licenses/odbl/summary/" class="external-link">ODbL</a>
license. If you use data, please ensure you (1) Attribute
Lynker-Spatial, (2) keep the data open, and that (3) any works produced
from this data offer that adapted database under the ODbL.</p>
<p>Hydrofabric data on <a href="https://www.lynker-spatial.com/data?path=hydrofabric%2F" class="external-link">lynker-spatial</a>
follows the general s3 URI pattern for access:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"{source}/{version}/{type}/{domain}_{layer}"</span></span></code></pre></div>
<p>Where:</p>
<ul>
<li>
<code>source</code> is the local or s3 location</li>
<li>
<code>version</code> is the release number (e.g. v2.2)</li>
<li>
<code>type</code> is the type of fabric (e.g. reference, nextgen,
etc)</li>
<li>
<code>domain</code> is the region of interest (e.g. conus, hawaii,
alaska)</li>
<li>
<code>layer</code> is the layer of the hydrofabric (e.g. divides,
flowlines, network, attributes, etc.)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="high-level-technical-overview">High level Technical Overview<a class="anchor" aria-label="anchor" href="#high-level-technical-overview"></a>
</h2>
<p>Below we provide more context on the data formats and technology we
rely on toe help make our data FAIR, easy to use, and</p>
<div class="section level3">
<h3 id="data-storage">Data Storage<a class="anchor" aria-label="anchor" href="#data-storage"></a>
</h3>
<p>We use <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" class="external-link">s3
(via aws)</a> for storage that is easy to sync locally, and access
remotely. The design of our data structure makes versioning easier to
track, and offer parity between local and remote access:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">version</span> <span class="op">&lt;-</span> <span class="st">"v2.2"</span></span>
<span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"reference"</span></span>
<span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="st">"conus"</span></span>
<span></span>
<span><span class="va">local_source</span> <span class="op">&lt;-</span> <span class="st">"/Users/mjohnson/hydrofabric"</span></span>
<span><span class="va">s3_source</span> <span class="op">&lt;-</span> <span class="st">"s3://lynker-spatial/hydrofabric"</span></span>
<span></span>
<span><span class="co"># Sync s3 with your local archive</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"aws s3 sync {s3_source}/{version}/{type} {local_source}/{version}/{type}"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## aws s3 sync s3://lynker-spatial/hydrofabric/v2.2/reference /Users/mjohnson/hydrofabric/v2.2/reference</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="data-formats">Data Formats<a class="anchor" aria-label="anchor" href="#data-formats"></a>
</h3>
<div class="section level4">
<h4 id="gpkg">GPKG<a class="anchor" aria-label="anchor" href="#gpkg"></a>
</h4>
<p>[Geopackages]((<a href="https://www.geopackage.org)/%5BSQLITE%5D(https://sqlite.org/index.html" class="external-link uri">https://www.geopackage.org)/[SQLITE](https://sqlite.org/index.html</a>)
is an open, standards-based, platform-independent, and data format for
spatial . It is designed to be a universal format for geospatial data
storage, enabling the sharing and exchange of spatial data across
different systems and software.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gpkg</span> <span class="op">&lt;-</span> <span class="st">"tutorial/poudre.gpkg"</span></span>
<span></span>
<span><span class="co"># See Layers</span></span>
<span><span class="fu">st_layers</span><span class="op">(</span><span class="va">gpkg</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Driver: GPKG </span></span>
<span><span class="co">## Available layers:</span></span>
<span><span class="co">##   layer_name geometry_type features fields             crs_name</span></span>
<span><span class="co">## 1    divides       Polygon     1122      5 NAD83 / Conus Albers</span></span>
<span><span class="co">## 2  flowlines   Line String     1129     19 NAD83 / Conus Albers</span></span>
<span><span class="co">## 3    network            NA     1145     23                 &lt;NA&gt;</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read Complete Layer</span></span>
<span><span class="op">(</span><span class="va">divides</span> <span class="op">=</span> <span class="fu">read_sf</span><span class="op">(</span><span class="va">gpkg</span>, <span class="st">"divides"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 1122 features and 5 fields</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -831675 ymin: 1975605 xmax: -757545 ymax: 2061555</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 1,122 × 6</span></span></span>
<span><span class="co">##    divide_id areasqkm has_flowline      id vpuid                            geom</span></span>
<span><span class="co">##        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;POLYGON [m]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>   2<span style="text-decoration: underline;">896</span>607   10.2   TRUE         2<span style="text-decoration: underline;">896</span>607 10L   ((-779895 2037405, -779835 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>   2<span style="text-decoration: underline;">896</span>609    5.08  TRUE         2<span style="text-decoration: underline;">896</span>609 10L   ((-777075 2041155, -777255 204…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>   2<span style="text-decoration: underline;">897</span>621    0.806 TRUE         2<span style="text-decoration: underline;">897</span>621 10L   ((-789255 2035395, -789255 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>   2<span style="text-decoration: underline;">897</span>627    2.52  TRUE         2<span style="text-decoration: underline;">897</span>627 10L   ((-802665 2036685, -802755 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>   2<span style="text-decoration: underline;">897</span>631    3.23  TRUE         2<span style="text-decoration: underline;">897</span>631 10L   ((-796005 2034945, -795855 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>   2<span style="text-decoration: underline;">897</span>671    1.42  TRUE         2<span style="text-decoration: underline;">897</span>671 10L   ((-780525 2033175, -780435 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>   2<span style="text-decoration: underline;">897</span>731    1.78  TRUE         2<span style="text-decoration: underline;">897</span>731 10L   ((-776655 2032545, -776775 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>   2<span style="text-decoration: underline;">897</span>785    2.93  TRUE         2<span style="text-decoration: underline;">897</span>785 10L   ((-774765 2032095, -774855 203…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>   2<span style="text-decoration: underline;">897</span>855    1.44  TRUE         2<span style="text-decoration: underline;">897</span>855 10L   ((-783765 2029515, -783735 202…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>   2<span style="text-decoration: underline;">897</span>893    2.86  TRUE         2<span style="text-decoration: underline;">897</span>893 10L   ((-774105 2028195, -773985 202…</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 1,112 more rows</span></span></span></code></pre>
</div>
<div class="section level4">
<h4 id="arrowparquet">Arrow/Parquet<a class="anchor" aria-label="anchor" href="#arrowparquet"></a>
</h4>
<p>Apache <a href="https://arrow.apache.org" class="external-link">Arrow</a> is an open-source
project that provides a columnar <strong>memory</strong> format for flat
and hierarchical data. It proviees fast data transfer and processing
across different programming languages and platforms without needing to
serialize and deserialize the data, making it particularly useful for
big data and high-performance applications.</p>
<p><a href="https://parquet.apache.org/docs/overview/" class="external-link">(geo)parquet</a>
is an <strong>on disc</strong> data format for storing columar data.
GeoParquet is an emerging standard for storing geospatial data within
the Apache Parquet file format. Parquet is a columnar storage file
format that is highly efficient for both storage and retrieval,
particularly suited for big data and analytics applications.</p>
<p>We distribute hydrofabric layers as VPU-based hive partitioned
(geo)parquet stores. These can be accessed from lynker-spatial, or,
synced (see above) to a local directory. Hive partitioning is a
partitioning strategy that is used to split a table into multiple files
based on partition keys. The files are organized into folders. The
complete <code>v2.2/reference/</code> directory is ~3.0GB while the
<code>v2.1.1/nextgen</code> dirctory is ~</p>
<div class="section level5">
<h5 id="parquet-store">Parquet store<a class="anchor" aria-label="anchor" href="#parquet-store"></a>
</h5>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{local_source}/{version}/{type}/{domain}_network"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## /Users/mjohnson/hydrofabric/v2.2/reference/conus_network</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## FileSystemDataset with 22 Parquet files</span></span>
<span><span class="co">## divide_id: double</span></span>
<span><span class="co">## areasqkm: double</span></span>
<span><span class="co">## id: double</span></span>
<span><span class="co">## toid: double</span></span>
<span><span class="co">## terminalpa: double</span></span>
<span><span class="co">## mainstemlp: double</span></span>
<span><span class="co">## reachcode: string</span></span>
<span><span class="co">## frommeas: double</span></span>
<span><span class="co">## tomeas: double</span></span>
<span><span class="co">## lengthkm: double</span></span>
<span><span class="co">## streamorde: double</span></span>
<span><span class="co">## totdasqkm: double</span></span>
<span><span class="co">## hydroseq: double</span></span>
<span><span class="co">## dnhydroseq: double</span></span>
<span><span class="co">## outlet_X: double</span></span>
<span><span class="co">## outlet_Y: double</span></span>
<span><span class="co">## hf_id: double</span></span>
<span><span class="co">## topo: string</span></span>
<span><span class="co">## hl_link: string</span></span>
<span><span class="co">## hl_reference: string</span></span>
<span><span class="co">## poi_id: int32</span></span>
<span><span class="co">## hl_uri: string</span></span>
<span><span class="co">## vpuid: string</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># &gt; Remote parity &gt;</span></span>
<span><span class="co"># open_dataset(glue('{s3_source}/{version}/{type}/{domain}_network/'))</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="geoparquet-store">Geoparquet store<a class="anchor" aria-label="anchor" href="#geoparquet-store"></a>
</h5>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{local_source}/{version}/{type}/{domain}_divides"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## /Users/mjohnson/hydrofabric/v2.2/reference/conus_divides</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## FileSystemDataset with 21 Parquet files</span></span>
<span><span class="co">## divide_id: double</span></span>
<span><span class="co">## areasqkm: double</span></span>
<span><span class="co">## geom: binary</span></span>
<span><span class="co">## has_flowline: bool</span></span>
<span><span class="co">## id: double</span></span>
<span><span class="co">## vpuid: string</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## See $metadata for additional Schema metadata</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># &gt; Renote parity &gt;</span></span>
<span><span class="co"># arrow::open_dataset(glue::glue('{s3_source}/{version}/{type}/conus_divides'))</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="parquet-schema">Parquet Schema<a class="anchor" aria-label="anchor" href="#parquet-schema"></a>
</h4>
<p>The <a href="https://github.com/manojkarthick/pqrs" class="external-link">pqrs</a> library
offers a command line tool of inspecting Parquet files</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">pqrs</span> schema /Users/mjohnson/hydrofabric/v2.2/reference/conus_flowlines/vpuid=01/part-0.parquet</span></code></pre></div>
<p><img src="../reference/figures/pqrs_nice_formating.png" width="622"></p>
</div>
<div class="section level4">
<h4 id="virtual-access-to-gridded-data-primary-cog-netcdf-zarr">Virtual Access to Gridded Data (Primary COG, NetCDF, Zarr)<a class="anchor" aria-label="anchor" href="#virtual-access-to-gridded-data-primary-cog-netcdf-zarr"></a>
</h4>
<p>The amount of gridded data needed for the suite of our supported
applications (let alone) - <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwil-fWKx_D-AhWCIzQIHXIHDD4QwqsBegQIAxAE&amp;url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DauK_gPR-e7M&amp;usg=AOvVaw2ITVtXkwdDj5PCzIfSQwbW" class="external-link">GDAL
VSI</a></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"/vsis3/lynker-spatial/gridded-resources/medium_range.forcing.tif"</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dap</span><span class="op">(</span>AOI <span class="op">=</span> <span class="va">divides</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="devcon2024-background_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="lazy-evaluation">Lazy Evaluation<a class="anchor" aria-label="anchor" href="#lazy-evaluation"></a>
</h3>
<p>All datasets are distributed at the <code>domain</code> level
(e.g. conus, hawaii, alaska). <a href="https://arrow.apache.org/cookbook/r/manipulating-data---tables.html" class="external-link">Lazy
evaluation</a> can help you get just the data you need, in memory from
local or remote locations.</p>
<div class="section level4">
<h4 id="local-gpkg">Local GPKG<a class="anchor" aria-label="anchor" href="#local-gpkg"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/as_sqlite.html">as_sqlite</a></span><span class="op">(</span><span class="va">gpkg</span>, <span class="st">"divides"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">divide_id</span> <span class="op">==</span> <span class="fl">2896607</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># Source:   SQL [1 x 7]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Database: sqlite 3.45.2 [/Users/mjohnson/github/hydrofabric/vignettes/tutorial/poudre.gpkg]</span></span></span>
<span><span class="co">##     fid          geom divide_id areasqkm has_flowline      id vpuid</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;blob&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1 <span style="color: #949494;">&lt;raw </span>2.21 kB<span style="color: #949494;">&gt;</span>   2<span style="text-decoration: underline;">896</span>607     10.2            1 2<span style="text-decoration: underline;">896</span>607 10L</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/as_sqlite.html">as_sqlite</a></span><span class="op">(</span><span class="va">gpkg</span>, <span class="st">"divides"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">divide_id</span> <span class="op">==</span> <span class="fl">2896607</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="../reference/read_sf_dataset_sqlite.html">read_sf_dataset_sqlite</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 1 feature and 6 fields</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -780615 ymin: 2037165 xmax: -777075 ymax: 2044425</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##     fid                        geom divide_id areasqkm has_flowline     id vpuid</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;POLYGON [m]&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1 ((-779895 2037405, -779835…   2<span style="text-decoration: underline;">896</span>607     10.2            1 2.90<span style="color: #949494;">e</span>6 10L</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="localremote-parquet-store">Local/Remote Parquet Store<a class="anchor" aria-label="anchor" href="#localremote-parquet-store"></a>
</h4>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{local_source}/{version}/{type}/conus_network/"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">101</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">toid</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">##      id    toid</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>   101 1<span style="text-decoration: underline;">078</span>719</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># &gt;</span></span>
<span><span class="co"># arrow::open_dataset(glue::glue('{s3_source}/{version}/{type}/conus_network/'))</span></span>
<span><span class="co"># %&gt;% &gt; dplyr::filter(id == 101) %&gt;% &gt; dplyr::select(id,</span></span>
<span><span class="co"># toid) %&gt;% &gt; dplyr::collect()</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="extracting-a-vpu">Extracting a VPU<a class="anchor" aria-label="anchor" href="#extracting-a-vpu"></a>
</h2>
<p>Last year we highlighted a system that was built largely around VPU
level gpkgs. While we no longer distribute these files, there is a
utility function <code><a href="https://rdrr.io/pkg/hfsubsetR/man/get_vpu_fabric.html" class="external-link">hfsubsetR::get_vpu_fabric</a></code> that will
extract a VPU level GPKG to a outfile of choice.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_vpu_fabric</span><span class="op">(</span><span class="st">"01"</span>, type <span class="op">=</span> <span class="st">"reference"</span>, hf_version <span class="op">=</span> <span class="st">"2.2"</span>,</span>
<span>    outfile <span class="op">=</span> <span class="st">"/Users/mjohnson/Downloads/01_ref_2.2.gpkg"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "/Users/mjohnson/Downloads/01_ref_2.2.gpkg"</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://mikejohnson51.github.io/" class="external-link">Mike Johnson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
