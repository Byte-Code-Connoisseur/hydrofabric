---
title: "NextGen Hydrofabric"
output:
  html_document:
    includes: 
      in_header: header2.html
      after_body: footer.html
---


<style type="text/css">

.title{
    display: none;
  }
  
.main-container {
  max-width: 1800px !important;
  padding-left: 250px;
  padding-right: 250px;
  margin-left: 0;
  margin-top: 0;
  margin-right: auto;
}


.blackbox {
  padding: 20px;
  background: #E5F1F9;
  color: black;
  border: 4px solid red;
  border-radius: 10px;
  margin-top: 30px;
  margin-bottom: 30px;
  margin-left: 0;
  margin-right: auto;
}

</style>


<center>
# Hydrofabric Schema
</center>
<br>
<br>

```{r, echo = F, message = FALSE, warning=FALSE}
library(sf)
```

Nextgen hydrofabric artifacts are distributed as as [geopackages](https://www.geopackage.org) by _NHDPlusV2_ **V**ector **P**rocessing **U**nits 

::: {#hello .blackbox .left}
**What is a geopackage?**

The GeoPackage Encoding Standard describes a set of conventions for storing the following within an SQLite database:

 - vector features (think POINTS, LINESTRINGS, POLYGONS)
 - attributes (non-spatial data)

A GeoPackage is the SQLite container and Standard that governs the rules and requirements of content. The GeoPackage standard defines the schema for a GeoPackage, including table definitions, integrity assertions, format limitations, and content constraints. The required and supported content of a GeoPackage is entirely defined in the standard. These capabilities are built on a common base and the extension mechanism provides implementors a way to include additional functionality in their GeoPackages.

Since a GeoPackage is a database container, it supports direct use. This means that the data in a GeoPackage can be accessed and updated in a "native" storage format without intermediate format translations. GeoPackages that comply with the requirements in the standard and do not implement vendor-specific extensions are interoperable across all enterprise and personal computing environments. GeoPackages are particularly useful on mobile devices such as cell phones and tablets in communications environments where there is limited connectivity and bandwidth.
:::

::: {#hello .main-container}

# What's in a VPU GPKG?

With in a geopackage, layers are vector or attribute tables that have some number of rows (features). If the table 

To see what is in a geopackage designed for the NextGen modeling task with can look at the file associated with VPU 01 and made available in the release for v1.0:

```{r, warning = FALSE, message=FALSE}
url = "/vsis3/nextgen-hydrofabric/v1.0/nextgen_01.gpkg"
sf::st_layers(url)
```

Below, we will describe these nine layers, and there respective fields.

## flowpaths

Flowpaths are a principle catchment realization and provide the needed input primarily for hydraulic and routing based modeling.

::: {#hello .blackbox .left}
**HY Feature flowpath:**
One-dimensional (linear) feature that is a hydrology-specific realization of the holistic catchment. Topologically, flowpath can be understood to be an edge bounded by inflow and outflow nodes, and associated with left-bank and right-bank sub-catchment faces. The concept of an edge bounded by nodes is described in detail in the ISO topology model [ISO19107]. 
:::

The flowpaths layer contains the following 9 feilds alongside a `LINESTRING` geometry:

| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the flowpath element | Prefixed with `wb-` |
| toid    | The unique identifier for the nexus element a flowpath flows **to** | Prefixed with `nex-` or  `tnex-` |
| lengthkm      | The length of the flowpath      | In kilometers  |
| slope_percent | The slope of the flowpath     |  unitless  |
| main_id      | The mainstem identifier of the flowpath | See [Mainstems](https://reference.geoconnex.us/collections/mainstems)  |
| member_comid      | The NHDPlusV2 COMIDs that contribute to this new flowpath      | comma separated string   |
| tot_drainage_areasqkm | The total upstream drainage      |  in sqaure kilometers |
| order      | Strahler Stream Order | See [Strahler number](https://en.wikipedia.org/wiki/Strahler_number) |
| realized_catchment      | The unique identifier of the realized catchment      |  The corresponding HY Feature divide realization ID  |
| geom | The geometry of the flowpath      |   In CRS EPSG:5070  |

## divides

Divides are a principle catchment realization and provide the needed input primarily for hydrologic modeling.

::: {#hello .blackbox .left}
**HY Feature Divide:**
One-dimensional (linear) feature that is a hydrology-specific realization of the holistic catchment. Topologically, catchment divide can be understood as an edge bounded by inflow and outflow nodes. The concept of an edge bounded by nodes is described in detail in the ISO topology model [ISO19107]. The catchment divide is usually represented as a geometric curve, or as a polygon ring feature.
:::

The divides layer contains the following 4 fields alongside a `POLYGON` geometry:

```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "flowpaths") %>% head()
```

| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the divide element | Prefixed with `cat-` |
| toid    | The unique identifier for the nexus element a divide flows **to** | Prefixed with `nex-` or  `tnex-` |
| areasqkm      | The area of the flowpath      | In square kilometers  |
| type | The type of catchment     |  `set:{network, sink, coastal}`  |
| geom | The geometry of the flowpath      |   In CRS EPSG:5070  |

## nexus

Nexus locations define that locations where information (model states, ect) can be exchanged. They are fundamental to the NextGen topology and model engine design.

::: {#hello .blackbox .left}
**HY Feature:**
Conceptual outlet for water contained by a catchment. The hydro nexus concept represents the place where a catchment interacts with another catchment. Every catchment flows to a hydro nexus, conversely every location in a hydrologic system can be thought of as a hydro nexus that drains some catchment. Similar to catchments, hydro nexuses can be realized in several hydrology-specific ways.

If a given hydro nexus does not have a known hydrology-specific realization or is undetermined, it is termed 'nillable' in this standard. For example, a hydro nexus exists in the form of flow to the subsurface or atmosphere but may be undetermined and unrepresented within implementations focused on surface water hydrology and would not be included or referenced.
:::

<br>
<br>

The nexus layer contains the following 3 fields alongside a `POINT` geometry:

```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "nexus") %>% head
```
| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the nexus element | Prefixed with `nex-` or `tnex-` |
| toid    | The unique identifier for the nexus element a divide flows **to** | Prefixed with `cat-` |
| type      | The area of the flowpath      | `set:{poi, infered}`  |
| geom | The geometry of the flowpath      | In CRS EPSG:5070  |

## flowpath_attributes

Flowpath attributes are needed to execute the [t-route routing module](https://github.com/NOAA-OWP/t-route). `t-route` was built to support the NWM v3.0 and requires a number of attributes defined in the WRF-hydro RouteLink file.

The values provided in the Routelink file are provided for each NHDPlusV2 COMID. To generate an analogous dataset for the refactored and aggregated network, we use the values in the RouteLink and compute a weighted average based on the porportion of a COMID contributing to a single flowpath. The flowpath_attributes layer contains the following 14 fields with defintions taken from [Page 88 of the WRF-Hydro Technical Manual](https://ral.ucar.edu/sites/default/files/public/WRF-HydroV5TechnicalDescription.pdf)


```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "flowpath_attributes") %>% names()
```

| Attribute        | Description           | Details | Source File | Summary Function |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the flowpath element | Prefixed with `wb-` | RouteLink_CONUS.nc |  |
| gages    | Identifier for stream gage at this location (if any) | per WRF-Hydro Routelink | RouteLink_CONUS.nc |  |
| NHDWaterbodyComID      | ComID of an associated waterbody (if any)  | per WRF-Hydro Routelink  | RouteLink_CONUS.nc |  |
| Qi      | Initial flow in flowpath      | [m^3 / sec]  | RouteLink_CONUS.nc |  |
| MusK | Muskingum routing time     | [sec]  | RouteLink_CONUS.nc |  |
| MusX      | Muskingum weighting coefficient | RouteLink_CONUS.nc |  |
| n    | Manning's Roughness | RouteLink_CONUS.nc |  |
| So      | Slope  | [m/m]   | RouteLink_CONUS.nc |  |
| ChSlp      |   Channel side slope   | [m/m]   | RouteLink_CONUS.nc |  |
| BtmWdth |   Channel bottom width    |  [m]  | RouteLink_CONUS.nc |  |
| Kchan      | Channel conductivity  | [mm/hr] | RouteLink_CONUS.nc |  |
| nCC    | Manning's Roughness Compound Channel |  RouteLink_CONUS.nc |  |
| TopWdthCC      | Flowpath Top Width      | [m]   | RouteLink_CONUS.nc |  |
| TopWdth      |  Xompund Channel Flowpath Top Width     | [m]   | RouteLink_CONUS.nc |  |


## flowpath_edge_list

Nextgen requires a topology table describing the connectivity of the flowpath network. This table isolates the `id` and `toid` columns of the flowpath LINESTRING layer.

```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "flowpath_edge_list") %>% names()
```

| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the flowpath element | Prefixed with `wb-` |
| toid    | The unique identifier for the nexus element a flowpath flows **to** | Prefixed with `nex-` or  `tnex-` |

## crosswalk

The crosswalk layer provides not only a crosswalk between the current hydrofabric and Points of Interest (like gages), but a way to relate the network to those used to build it (NHDPlus, reference, refactor). In this table every row is an entry - where the minimal network is the NHDPlusCOMID.

```{r, echo = FALSE, eval = FALSE}
read_sf(url, "crosswalk") %>% names()
```

| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id                    | The unique identifier for the flowpath element | Prefixed with `wb-` |
| toid                  | The unique identifier for the nexus element a flowpath flows **to** | Prefixed with `nex-` or `tnex-` |
| NHDPlusV2_COMID       | The NHDPlusCOMID | integer  |
| NHDPlusV2_COMID_part  | If the original NHDPlus COMID was split, the subpart  | Parts increase from outlet to inlet |
| mainstem              | The mainstem identifier of the flowpath | See [Mainstems](https://reference.geoconnex.us/collections/mainstems)  |
| POI_ID                | The unique POI identifier for the reference fabric |  |
| POI_TYPE              | The type of POI | comma separated list  |
| POI_VALUE             | The native dataset identifier of all POI_TYPEs | comma separated list  |

## nwm1km_weights

Many OWP supported models require initial parameters to execute. Computing catchment scale values from gridded data requires the ability to identify and then quickly and accurately summarizes raster values over polygonal areas including partially covered grid cells. The relationship betwe en divide, cell ID, and the coverage fraction can be stored in a weights file.  For more information on how this is accomplished please see the [zonal package](https://github.com/NOAA-OWP/zonal) which has produced the ability to summarize decades of data, for areas as large as the east coast, in minutes on a personal laptop (this package is included in the `hydrofabric` meta package). The `nwm1km_weights` provides the weight grid relating the Nextgen catchments to the WRF-Hydro domain grids:

```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "nwm1km_weights") %>% head()
```
| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the catchment element | Prefixed with `cat-` |
| cell    | The cell number of the NWM geogrid (and soilgrid)  | Reads from top left to bottom right  |
| coverage_fraction      | The percent of [cell] covered by catchment [id] |

## cfe_noahowp_attributes

The NOAA supported CFE and NOAA-OWP models require specific values from the NWM Groundwater, soil, and WRF grids to run. Below the attributes computed with the `nwm1km_weights` layer are shown along with the summary function used to compute the catchment scale value (e.g. "max temperature per catchment" vs "mean temperature per catchment")

```{r, echo = FALSE, eval = FALSE}
sf::read_sf(url, "cfe_noahowp_attributes") %>% names()
```


| Attribute        | Description           | Layer(s)  | Summary Function | Source | 
| ------------- |:-------------:| -----:| -----:| -----:|
| bexp      | Beta Parameter| 4 | mode | soilproperties_CONUS_FullRouting.nc |
| IVGTYP      | Dominant category    | 1   | mode | wrfinput_CONUS.nc |
| ISLTYP | Dominant category      |  1   | mode | wrfinput_CONUS.nc |
| dksat      | Saturated Soil Connectivity | 4  | geometric mean | soilproperties_CONUS_FullRouting.nc |
| psisat      | Saturated soil matric potential      | 4   | geometric mean | soilproperties_CONUS_FullRouting.nc |
| slope | Slope Index      |   1 | mean | soilproperties_CONUS_FullRouting.nc |
| smcmax      | Saturated value of soil moisture [volumetric] | 4 | mean | soilproperties_CONUS_FullRouting.nc |
| smcwlt      | Wilting point soil moisture [volumetric]     |  4  | mean | soilproperties_CONUS_FullRouting.nc |
| refkdt | Parameter in the surface runoff parameterization      |  1  | mean | soilproperties_CONUS_FullRouting.nc |
| cwpvt      | Empirical canopy wind parameter | 1 | mean | soilproperties_CONUS_FullRouting.nc |
| vcmx25      | Maximum rate of carboxylation at 25 C [ umol CO2/m2/s]      | 1  | mean | soilproperties_CONUS_FullRouting.nc |
| mp | Slope of Conductance to photosynthesis relationship      | 1   | mean | soilproperties_CONUS_FullRouting.nc |
| mfsno      | Snowmelt m parameter | 1 | mean | soilproperties_CONUS_FullRouting.nc |
| Coef      | Coefficient | 1 | mean | GWBUCKPARM_CONUS_FullRouting.nc |
| Zmax      | Zmax | 1 | mean | GWBUCKPARM_CONUS_FullRouting.nc |
| Expon      | Exponent | 1 | mode | GWBUCKPARM_CONUS_FullRouting.nc |

## aorc_weights

As a preliminary option for the forcing engine, the AORC weight grids are computed and available for use:

```{r, echo = FALSE, eval = FALSE}
read_sf(url, "aorc_weights") %>% names()
```

| Attribute        | Description           | Details |
| ------------- |-------------|  -------------| 
| id      | The unique identifier for the catchment element | Prefixed with `cat-` |
| cell    | The cell number of the AORC gridded files  | Reads from top left to bottom right  |
| coverage_fraction      | The percent of [cell] covered by catchment [id] |
:::

<br>
<br>
<br>
<br>
<br>
<br>