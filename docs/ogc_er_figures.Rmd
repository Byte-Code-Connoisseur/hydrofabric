---
title: "OGC ER Figures"
author: "Mike Johnson"
date: "2022-11-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r, echo = FALSE}
pacman::p_load(terra, tidyterra, sf, ggplot2, dplyr, opendap.catalog, nhdplusTools, gridExtra)

path = '/Users/mjohnson/Downloads/GF_01.gpkg'

# xx = filter(read_sf(path, 'mapped_POIs'), !is.na(Type_Gages))
# 
# origin = xx$ID[1]

origin = read_sf(path, 'mapped_POIs') %>% 
filter(identifier == 1142) %>% 
  pull(ID)

flowpath_edgelist = 'catchment_network'
flowpath_name     = 'aggregated_flowpaths'
catchment_name    = 'aggregated_divides'

trace = read_sf(path, flowpath_edgelist) %>% 
  select(ID = id, toID = toid) %>% 
  get_sorted(outlets = origin) 

ids = unique(unlist(trace))

inputs = list()

inputs[['flowpaths']] = filter(read_sf(path,  flowpath_name),  ID %in% ids) %>% 
  select(-toID) %>% 
  left_join(trace, by = "ID") %>% 
  mutate(toid = ifelse(is.na(toID), 0, toID))

inputs[['divides']]   = suppressWarnings({
  filter(read_sf(path,  catchment_name), ID %in% inputs$flowpaths$ID) 
})

inputs[['pois']] = read_sf(path, 'mapped_POIs')[inputs$divides, ]

dem = '/vsis3/nextgen-hydrofabric/dem.vrt'
imperv_nlcd = '/vsicurl/https://storage.googleapis.com/feddata-r/nlcd/2019_Impervious_L48.tif'

inputs[['elev']] = opendap.catalog::dap(URL = dem, AOI = inputs$divides) %>% 
  mask(vect(inputs$divides))

inputs[['imperv']] = opendap.catalog::dap(URL = imperv_nlcd, AOI = inputs$divides) %>% 
  mask(vect(inputs$divides))

inputs[['og_cats']] = base_cats = st_intersection(get_nhdplus(AOI = st_union(inputs$divides), 
                                                                realization = 'catchment'), 
                                                    inputs$divides)
```  

# 1. Hydrologic Control Volume Definition

Show a detailed flowpath network (light / background), elevation data, a set of pour points (POIs), and the aggregate
catchments.

```{r, echo = FALSE}
ggplot() +
  geom_spatraster(data = inputs$elev, alpha = .8, ) +
  scale_fill_whitebox_c() +
  geom_sf(data = inputs$divides, fill = NA) + 
  geom_sf(data = inputs$flowpaths, color = "blue") + 
  geom_sf(data = inputs$pois, color = "red") + 
  theme_void() + 
  theme(legend.position="none")
```

# 2. Hydrologic Network Connectivity

Same as figure 1 but emphasizing the flowpaths

```{r, echo = FALSE}
ggplot() +
  geom_spatraster(data = inputs$elev, alpha = .4) +
  scale_fill_distiller(type = "seq",
                       na.value = "white",
                       direction = -1,
                       palette = "Greys") +
  geom_sf(data = inputs$divides, fill = NA, lwd = .5) +
  geom_sf(data = inputs$flowpaths, color = "blue", lwd = 1) + 
  geom_sf(data = inputs$pois, color = "black") + 
  theme_void() + 
  theme(legend.position="none")
```

# 3. Catchment Aggregates

Same figure 1 but including the catchments for the detailed flowpath network.

```{r, echo = FALSE}
ggplot() +
  geom_spatraster(data = inputs$elev, alpha = .4) +
  scale_fill_distiller(type = "seq",
                        na.value = "white",
                        direction = -1,
                        palette = "Greys") +
  labs(fill = "elevation") + 
  geom_sf(data = inputs$og_cats, fill = NA, lwd = .2) + 
  geom_sf(data = inputs$divides, fill = NA, color = "red", lwd = 1) +
  geom_sf(data = inputs$flowpaths, color = "navy", lwd = .5) + 
  geom_sf(data = inputs$pois, color = "black") + 
  theme_void() + 
  theme(legend.position="none")
```

# 4. Catchment Characterization

Overlay divides on impervious surface and place next to idealized table of summary

```{r, echo = FALSE}
df1 = data.frame(ID = c(paste0('cat-', 1:4), "..."), percent_impervious = c(round(runif(4, 0, .5), 2), "..."))

tt <- ttheme_default(colhead=list(fg_params = list(parse=TRUE)),
                     base_size = 20,
                     padding = unit(c(2, 4), "mm"))

tbl <- tableGrob(df1, rows=NULL, theme=tt)

g = ggplot() +
  geom_spatraster(data = rast(raster::raster(inputs$imperv)), alpha = .8) +
  scale_fill_distiller(type = "seq",
                       na.value = "white",
                       direction = -1,
                       palette = "YlOrRd") +
  geom_sf(data = inputs$divides, fill = NA, lwd = 1) +
  theme_void() + 
  theme(legend.position="none")

grid.arrange(g, tbl, ncol = 2, widths = c(5,5))
```

# 5. River Corridor Characterization

Similar to Figure 1, but emphasize a buffer around flowpaths rather than the aggregate catchment boundaries.

```{r, echo = FALSE}
rc = mask(inputs$elev, vect(st_buffer(st_union(inputs$flowpaths), 1000)))

ggplot() +
  geom_spatraster(data = rc, alpha = .8) +
  scale_fill_whitebox_c() + 
  geom_sf(data = inputs$divides, fill = NA, lwd = .5) +
  geom_sf(data = inputs$flowpaths, color = "navy", lwd = .2) + 
  geom_sf(data = inputs$pois, color = "black") + 
  theme_void() + 
  theme(legend.position="none")
```

# 6. Hydrologic Location

Similar to Figure 1, but emphasize a buffer around flowpaths rather than the aggregate catchment boundaries.

```{r, echo = FALSE}

#mapview::mapview(inputs$divides) + inputs$flowpaths
tmp = inputs$divides[7,]
tmp_fl = filter(inputs$flowpaths, ID == tmp$ID)
tmp_elev = mask(crop(inputs$elev, vect(tmp)),vect(tmp))

pts = st_line_sample(tmp_fl, 3) %>% 
  st_cast("POINT") %>% 
  st_as_sf() %>% 
  mutate(Type = c("Gage", "Facility", "Intake")) %>% 
  rename_geometry("geometry")

outlet = get_node(tmp_fl, "end") %>% 
  mutate(Type = "Outlet") 

pts = bind_rows(pts, outlet)

pts$dist = round(as.numeric(st_distance(pts, outlet) / st_length(tmp_fl)), 2)

g1 = ggplot() +
  geom_spatraster(data = tmp_elev, alpha = .4) +
  scale_fill_distiller(type = "seq",
                       na.value = "white",
                       direction = -1,
                       palette = "Greys", guide = "none") +
  geom_sf(data = tmp, fill = NA, lwd = 1) + 
  geom_sf(data = tmp_fl, color = "navy", lwd = 2) +
  geom_sf(data = pts, color = "black", size = 5.5) + 
  geom_sf(data = pts, aes(color = Type), size = 5) + 
  labs(color = "Hydrolocation Type") +
  theme_void() + 
  theme(legend.position="bottom")


tt2 <- ttheme_default(colhead=list(fg_params = list(parse=TRUE)),
                     base_size = 12,
                     padding = unit(c(2, 4), "mm")) 
df2 = select(st_drop_geometry(pts), Type, `Hydrologic Location` = dist)

tbl2 <- tableGrob(df2, rows=NULL, theme=tt2)

grid.arrange(g1, tbl2, ncol = 2, widths = c(5,5))
```



```{r, echo = FALSE}

path = '/Users/mjohnson/Downloads/GF_02.gpkg'

origin = 10002405
origin2 = 10004177

net = read_sf(path, flowpath_edgelist) %>% 
   select(ID = id, toID = toid)

y = 2

trace  = bind_rows(tail(get_sorted(net, outlets = origin), y), 
                   tail(get_sorted(net, outlets = origin2), y))
 

ids = unique(unlist(trace))

fl_inputs = list()

fl_inputs[['flowpaths']] = filter(read_sf(path,  flowpath_name),  ID %in% ids) %>% 
  select(-toID) %>% 
  left_join(trace, by = "ID") %>% 
  mutate(toid = ifelse(is.na(toID), 0, toID))

fl_inputs[['divides']]   = suppressWarnings({
  filter(read_sf(path,  catchment_name), ID %in% fl_inputs$flowpaths$ID) 
})

fl_inputs[['pois']] = read_sf(path, 'mapped_POIs')[fl_inputs$divides, ]

dem = '/vsis3/nextgen-hydrofabric/dem.vrt'

fl_inputs[['elev']] = dap(URL = dem, AOI = fl_inputs$divides) %>% mask(vect(fl_inputs$divides))

fl_inputs[['og_fl']] = st_intersection(get_nhdplus(AOI = st_union(fl_inputs$divides)), fl_inputs$divides)

```

# Flowlines 

```{r, echo = FALSE}
ggplot() +
  geom_spatraster(data = fl_inputs$elev, alpha = .4) +
  scale_fill_distiller(type = "seq",
                       na.value = "white",
                       direction = -1,
                       palette = "Greys", guide = "none") +
  geom_sf(data = fl_inputs$divides, fill = NA, lwd = .8) + 
  geom_sf(data = fl_inputs$og_fl, color = "red", lwd = .5) + 
  geom_sf(data = fl_inputs$flowpaths, color = "blue", lwd = .8) +
    geom_sf(data = fl_inputs$pois, color = "black", size = 5) + 
  geom_sf(data = fl_inputs$pois, color = "darkgreen", size = 4) + 
  theme_void() + 
  theme(legend.position="bottom")
```

# Flow network Location

Similar to flowline figure but with a fish sample, a water quality sample, and a velocity measurement on a diverted channel.

```{r, echo = FALSE}
div_id = 22741689

hucs  = select(mutate(filter(fl_inputs$pois, !is.na(Type_HUC12)), Type = "HUC12"), Type) %>% 
  rename_geometry("geometry")

fish_sample = filter(fl_inputs$og_fl, comid != div_id) %>% 
  st_union() %>% 
  st_line_merge() %>% 
  st_cast("LINESTRING") %>% 
  st_as_sf() %>% 
  sample_n(2) %>% 
  st_line_sample(1) %>% 
  st_cast("POINT")  %>% 
  st_as_sf() %>% 
  mutate(Type = "Fish Sample") %>% 
  rename_geometry("geometry")

vel = filter(fl_inputs$og_fl, comid == div_id) %>% 
  st_line_sample(1) %>% 
  st_as_sf() %>% 
  mutate(Type = "Velocity Measurement") %>% 
  rename_geometry("geometry")

pts = bind_rows(hucs, fish_sample, vel) %>% 
  st_cast("POINT")

ggplot() +
  geom_spatraster(data = fl_inputs$elev, alpha = .4) +
  scale_fill_distiller(type = "seq",
                       na.value = "white",
                       direction = -1,
                       palette = "Greys", guide = "none") +
  geom_sf(data = fl_inputs$divides, fill = NA, lwd = .8, guide = "none") + 
  geom_sf(data = fl_inputs$og_fl, color = "red", lwd = .5, guide = "none") + 
  geom_sf(data = fl_inputs$flowpaths, color = "blue", lwd = .8, guide = "none") +
  geom_sf(data = pts, color = "black", size = 3) + 
  geom_sf(data = pts, aes(color = Type), size = 2) + 
  labs(color = "Hydrolocation Type") +
  theme_void() + 
  theme(legend.position="bottom")
```